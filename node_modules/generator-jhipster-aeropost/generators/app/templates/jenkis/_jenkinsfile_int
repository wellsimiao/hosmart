pipeline {
    agent any
    tools {
            maven 'maven-3.5.3' 
    	    jdk 'java-8-openjdk'
        }
    stages {
        stage("Checkout") {
               steps {
                    git branch: '${branch}',
                        credentialsId: '<%=gitCredentialsId%>',
                        url: '<%=gitBranch%>'
               }
        }
        stage("Compile") { 
            steps {
                sh "chmod a+x ./mvnw"
                sh "./mvnw -Pint,graphite clean package -DskipTests=true"
            }
        }
       // stage("build & SonarQube analysis") {
       //     steps {
       //       withSonarQubeEnv('localhost') {
       //         sh 'mvn clean package sonar:sonar'
       //       }
       //     }
       // }
      //  stage("Quality Gate") {
      //      steps {
      //        timeout(time: 1, unit: 'HOURS') {
      //          waitForQualityGate abortPipeline: true
      //        }
      //      }
      //  }
        stage("Docker") {
            steps {
                sh "./mvnw verify dockerfile:build -Pint -DskipTests=true"
                sh "./mvnw dockerfile:push -Ddockerfile.useMavenSettingsForAuth=true -Pint -s /opt/apache/maven/3.5.3/conf/settings.xml"
            }
        }
        stage("Deploy") {
            steps {
                sh "./mvnw resources:resources -Pfilter-resources,int"
                sh "mkdir -p <%=vsDocker%>:/opt/docker_compose/<%=projectName%>"
                sh "scp ./src/main/docker/app-int.yml <%=vsDocker%>:/opt/docker_compose/<%=projectName%>"
                withCredentials([usernamePassword(credentialsId: 'auto-build_Registry-DEV', passwordVariable: 'password', usernameVariable: 'username')]) {
                //    sh "cat ./target/classes/deploy/deploy.sh $username $password"
                    sh "ssh vs-docker-dev1.ord.int.aeropost.com 'bash -s' <  ./target/classes/deploy/deploy.sh $username $password"
                }
            }
        }
    }
}