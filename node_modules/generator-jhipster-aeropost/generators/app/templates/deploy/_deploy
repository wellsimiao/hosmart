#!/bin/bash

registryUser=$1
registrypass=$2
composeFile=/opt/docker_compose/@project.artifactId@/app-@spring.profiles.active@.yml

set -ex

echo "Stop Composer"
docker stack rm <%=baseName%>

{ 
	if [ "$(docker images -q @docker.repository.url@/@docker.image.prefix@/@project.artifactId@-@spring.profiles.active@ | uniq)" ]; then
		docker rmi -f $(docker images -q  @docker.repository.url@/@docker.image.prefix@/@project.artifactId@-@spring.profiles.active@ | uniq) &&
		echo "Remove all images"
	fi
} || {
    echo "Fail to remove all images"
}


echo "Pull image from repository"
docker login -u ${registryUser} -p ${registrypass} docker-registry-dev.int.aeropost.com:5000
docker pull @docker.repository.url@/@docker.image.prefix@/@project.artifactId@-@spring.profiles.active@:@project.version@-@spring.profiles.active@

echo "Run Composer"
docker stack deploy --compose-file=${composeFile} <%=baseName%>